#define __STDC_WANT_LIB_EXT1__ 1

#include <string.h>
#include <stdio.h>
#include <stdlib.h>
  
  
/* 
    This C snippet exhibits errors caught by neither gcc nor splint, but caught by clang-tidy 

    └─$ splint EXP34-C_caught_by_clang.c
    Splint 3.1.2 --- 21 Feb 2021

    Finished checking --- no warnings

    └─$ clang-tidy EXP34-C_caught_by_clang.c
    Error while trying to load a compilation database:
    Could not auto-detect compilation database for file "EXP34-C_caught_by_clang.c"
    No compilation database found in /home/kali/Downloads/test_code_review or any parent directory
    fixed-compilation-database: Error while opening fixed database: No such file or directory
    json-compilation-database: Error while opening JSON database: No such file or directory
    Running without flags.
    1 warning generated.
    /home/kali/Downloads/test_code_review/EXP34-C_caught_by_clang.c:38:21: warning: Dereference of null pointer (loaded from variable 'sk') [clang-analyzer-core.NullDereference]
        if (!sk) return *sk;
                        ^~~
    /home/kali/Downloads/test_code_review/EXP34-C_caught_by_clang.c:36:5: note: 'sk' initialized here
        int *sk = tun->sk;
        ^~~~~~~
    /home/kali/Downloads/test_code_review/EXP34-C_caught_by_clang.c:38:9: note: Assuming 'sk' is null
        if (!sk) return *sk;
            ^~~
    /home/kali/Downloads/test_code_review/EXP34-C_caught_by_clang.c:38:5: note: Taking true branch
        if (!sk) return *sk;
        ^
    /home/kali/Downloads/test_code_review/EXP34-C_caught_by_clang.c:38:21: note: Dereference of null pointer (loaded from variable 'sk')
        if (!sk) return *sk;
*/

/* 
---- EXP34-C. Do not dereference null pointers ----
 */



/*  
Example 2
The sk pointer is initialized to tun->sk before checking if tun is a null pointer. Because null pointer dereferencing is undefined behavior, the compiler (GCC in this case) can optimize away the if (!tun) check because it is performed after tun->sk is accessed, implying that tun is non-null. 
*/
typedef struct {
    int *sk;
} tun;
typedef struct {
    tun *private_data;
} tun_file;

/*@unused@*/ static int tun_chr_poll(tun_file *file)  {
    tun *tun = file->private_data;
    int *sk = tun->sk;
    /* next check may be optimized away by compiler!!! */
    if (!sk) return *sk;
    return -1;

}


/* main */
int main(int argc, char *argv[]) {
    int i;
    printf("%d\n",argc);
    for(i=0;i<argc-1;i++)
    {
        printf("%s", argv[i]);
    }    
    return 0;    
}
