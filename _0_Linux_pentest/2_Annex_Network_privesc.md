---
title: Network privilege escalation 
---


- [Prerequisites](#prerequisites)
  - [ADV expected contents](#adv-expected-contents)
- [General privilege escalation](#general-privilege-escalation)
  - [Inventory of network connections](#inventory-of-network-connections)
    - [Listening services](#listening-services)
      - [Network scan](#network-scan)
      - [Whitebox shortcut](#whitebox-shortcut)
    - [Other connections from the TOE](#other-connections-from-the-toe)
    - [Map the protocols that will be targeted next](#map-the-protocols-that-will-be-targeted-next)
  - [Search protocol vulnerabilities](#search-protocol-vulnerabilities)
    - [Inventory](#inventory)
    - [Design](#design)
    - [Implementation/configuration](#implementationconfiguration)
  - [Exploit protocol vulnerabilities](#exploit-protocol-vulnerabilities)
    - [Capture](#capture)
      - [On the network](#on-the-network)
      - [On the TOE](#on-the-toe)
    - [Analysis](#analysis)
    - [Packet modification or crafting](#packet-modification-or-crafting)
    - [\[optional:\] Bypass firewalling on the TOE](#optional-bypass-firewalling-on-the-toe)
- [Other topics](#other-topics)
  - [Evasion (FW/IDS/gateway/diodes...)](#evasion-fwidsgatewaydiodes)
  - [Pass or craft malicious data through the TOE](#pass-or-craft-malicious-data-through-the-toe)


# Prerequisites

## ADV expected contents
In a CC evaluation, for each topic, the evaluator will first try to determine whether the ADV documentation is sufficiently clear. In a second step, the evaluator will check that the TOE conforms to this description. This second check should preferably be performed during the ADV review is the TOE is already available, but can be performed later.
In a whitebox evaluation, the evaluator will only perform the second check. 

NB: we will focus the AVA analysis on parts that have been patched/developed by the developer. 
Other programs can be skipped in the context of an AVA_VAN.3: we do not expect to be able to find vulnerabilities is known linux components in the constraint time of an evaluation.

| Topic | Expected content of ADV |
| :---- | :----   |
| General list of network dependencies|List the third-parties that are expected to be connected to the TOE through the network:<br> - does the product use a third-party SSO? PKI services such as OCSP?<br> - does the product rely on an external NTP, etc.?<br> - does the product rely on a back office for licensing, product updates? <br> - does the product rely on repositories to update 3rd party building blocks (distro, libraries...)?<br> - etc.|
| Supported protocols - Data link layer | Describe which standards are supported by the TOE at the link layer, with a focus on security protocols<br>Example: _The TOE supports 802.03/ethernet, and wifi/802.11 with WPA2/802.11i. (WEP is not supported)_|
| Supported protocols - Internet layer | Describe which standards are supported by the TOE at the internet layer, with a focus on security protocols.<br>Example: _The TOE supports IPv4 and IPv6_<br>Example2: _The TOE supports IPSec/ESP in tunnel mode on IPv6 only (no IPv4), with the following cipher suites: etc._|
| Supported protocols - network layer | Describe which standards are supported by the TOE at the network layer, with a focus on security protocols.<br>Example: _The TOE supports mainly TCP connections. UDP is used as underlying layer for several utilities: NTP and DHCP_|
| Supported protocols - applicative layer | List all the programs/services/TOE parts that uses the network and describe:<br> - whether the TOE is server or client <br> - which ports are used<br> - which applicative protocols are used, and according to which standard (if several are available)<br>If the TOE includes pure upstream components, the developer does not have to describe all the applicative protocols used by these components. However, the configuration of these services must be clearly described. For example, if the TOE includes a full non-patched Linux, the developer should still explain which network-aware services are loaded and why they are needed.<br>For TOE parts, prefer a description at process level. Comment the attribution of network-related capabilities if any|
|Firewalling|Describe which firewalling features are in place on the TOE (e.g. iptables, ufw...) and explain their default configuration|

# General privilege escalation
## Inventory of network connections
### Listening services

#### Network scan 
Starting from an anonymous access (no UDP research by default)
````nmap -n -T4 -sV <IP>```` coresponds to a very quick scan on most used ports: it should only be used on an easy challenge that is likely to expose low hanging fruits
If there is a minimum level of coverage expected, use ````nmap -n -T4 -p 1-65535 -sS <IP>````... then adapt
 - if the TOE seems to have a reasonable attack surface, try a slow comprehensive scan
````nmap -sS -sU -A -v -PE -PP -PS80,443 -PA3389 -PU40125 -PY -g 53 --script "default or (discovery and safe)" <IP>````
 - if not, clarify with the developer why the surface is so large

NB: explanations
 - -n/-R: Never/Always do DNS resolution (here we don't resolve because we address the IP)
 - -T<0-5>: Set timing template (higher is faster): here we try to do a "fast scan"
 - -p 1-65535 : all possible ports
 - -sS : TCP SYN
- 

[TODO]: elaborate on the choice of options... See alternative proposals courtesy of Hacktricks
````
# Nmap fast scan for the most 1000tcp ports used
nmap -sV -sC -O -T4 -n -Pn -oA fastscan <IP> 
# Nmap fast scan for all the ports
nmap -sV -sC -O -T4 -n -Pn -p- -oA fullfastscan <IP> 
# Nmap fast scan for all the ports slower to avoid failures due to -T4
nmap -sV -sC -O -p- -n -Pn -oA fullscan <IP>
#Bettercap Scan
syn.scan 192.168.1.0/24 1 10000 #Ports 1-10000
````
And for UDP:
````
# Check if any of the most common udp services is running
udp-proto-scanner.pl <IP> 
# Nmap fast check if any of the 100 most common UDP services is running
nmap -sU -sV --version-intensity 0 -n -F -T4 <IP>
# Nmap check if any of the 100 most common UDP services is running and launch defaults scripts
nmap -sU -sV -sC -n -F -T4 <IP> 
# Nmap "fast" top 1000 UDP ports
nmap -sU -sV --version-intensity 0 -n -T4 <IP>
# You could use nmap to test all the UDP ports, but that will take a lot of time
````

#### Whitebox shortcut
````
sudo netstat -tulpn 
````
NB:
it may be useful to identify all connections (not only the ones listening) in case some network client on the TOE could open a vulnerable channel: 
````
sudo netstat -tuapn 
````


### Other connections from the TOE
The verification of listening services is not enough and many other conections may be created on-demand! confront what you can find on the TOE to the description in ADV
For example 'apt' will create a client to connect to repos, and it will not appear in the listening services - What happens if
 - the repo is accessed in http (which is frequent) **and** does not sign packages? (which should not happen)
 - the repo is unofficial, untrusted and may well be considered compromised by default?

[TODO]: How to search independently for such possible on-demand accesses? 
 - bad idea: listen on wireshark during the whole ATE tests. why is it a bad idea? even `apt` may be considered a non interfering feature and not tested/used during ATE
 - search for http: ftp: in config files, e.g. ````sudo find /etc/ -type f -exec grep -H 'http:' {} \;````? 
 - check nginx settings for https configs and /etc/xxx/ssl + /etc/xxx/xxx.conf.d for keys 
 - etc

### Map the protocols that will be targeted next
The evaluator shall
 - Map the open ports to services
 - classify the discovered network services :
   - *TSF relevant* : services (and traffic) pertaining to the trusted path to authenticated users, or protected communications with other IT Products. This can be plaintext (e.g. a simple HTTP session) or encrypted (e.g. TLS records). This obviously includes *underlying layers* (e.g. the TCP/IP layer under the TLS session, ICMP, DNS...)
   - *non TSF relevant* (e.g. an additional HTTP service not directly related to the user session) 
 - compare the result to the description in ADV and ALC to check, for each service, if it is:
   - a well known open source component (possibly patched by the developer)
   - anything other that that: open source but not well known, downright shady source, or simply proprietary developement
 - for the non relevant services, check if they run with significant privileges (for example, if the service runs as root or if it gives a full session to the user, e.g. ssh)
 - Comment any discrepancy and clarify with the developer - additional services running on the TOE, etc.

| Type   | Test the configuration and CVEs? | Test the implementation? | Review the design? |    
  | :----   |     :----      |  :---     | :---     |       
 | TSF relevant   | yes | Only the parts or patches that are proprietary/_not well known_ | If proprietary/_not well known_ |
 | non TSF relevant but running with some privileges | yes | yes |no|
 | no impact on TSF  | no | no | no |


## Search protocol vulnerabilities


### Inventory
What are the protocols used on the channel to the user/other party?
 - which one provides identification/authentication and how (mutual or not, multi factor or not, which types of credentials...)? 
 - which one provides session management and how (tokens, cookies...)?
 - which one provides relay protection and how?
 - which one provides integrity/confidentiality protection and how?
 - which one provides authorization and how?

### Design
Not applicable to known/standard protocols, this makes sense when analyzing a proprietary or rare protocol.
It also makes sense for session management, as there is often no standard protocol involved. Typically, errors in token management may happen easily (e.g. accepting the same token for different users, or on different ports/networks, etc.)

[TODO]: check design of proprietary protocols

### Implementation/configuration 
When a standard protocol provides a given security property (e.g. integrity /confidentiality), you still need to check whether it is correctly implemented - this will be a question of conformance to standards/best practices. This can be checked:
 - either at the network level, when a complete test suite is available:
   - e.g. TLS with Achelos / tlssled
 - or at the [applicative level](_0_Linux_pentest\3_Annex_Applicative_privesc.md)

Is the implementation robust, both for the part that implements the session *and for the underlying network stack*? (think fuzzing)

## Exploit protocol vulnerabilities
On the principle, it consists in
 - perform a MiTM or sniff the network
 - intercept/capture packets 
 - read, replay or transform the packets (and in that case send the transformed packets to the other party)

Some variations are possible, such as exploiting a session that was not clearly terminated to impersonate a party, etc.

### Capture
[TBD] Tips to:
- how to be sure to trigger all actions on the TOE that that will actually create interesting traffic 
- how to denoise captures before analysis 
#### On the network
- setup
- capture : wireshark/tshark, tcpdump, scapy
#### On the TOE
- setup
- eBPF...

### Analysis
How to analyze captured packets:
- origin (traceback) and;
- content (understanding packet analyzers such as Wireshark, snort, tcpdump/windump, fiddler, suricata, netsniff-ng, but also dissection with scapy), and;
- understanding of capture formats (pcap, other?).
### Packet modification or crafting
nc, pwntools...
How to handle packets (scapy, fragroute, etc.). 
The evaluator must ultimately be able to carry out a complete Man-in-the-middle/spoofing attack.
In addition to packet manipulation tools, particularly if he wishes to take advantage of an open sample, the evaluator can also proceed by hooking the TOE or software interacting with the TOE (for example existing test tool), or even modify the source code of such software in order to generate malicious frames.

### [optional:] Bypass firewalling on the TOE
TBD

# Other topics
## Evasion (FW/IDS/gateway/diodes...)
[TODO] add external resources on FW evasion and discuss - testing FW evasion is tricky, since it is dependent on context, rules expressiveness and usability, etc. For the moment, this aspect is not addressed in this method and is considered more a functional test of the FW capacity than a security topic. The same rules holds for gateway that allow or block traffic based on protocol analyses.
[TODO] attacks on directionality / protocole translation
[TODO] out of scope: HW attacks on optical diodes

## Pass or craft malicious data through the TOE
this case is a bit different, since it supposes that the attacker can use the TOE itself to transform input data in malicious data for other systems connected to the TOE. It requires 
 - either that the attacker exploits TOE input transformation rules,  
 - or that the attacker elevates their privileges on the TOE to craft arbitrary malicious data. In real life scenarios, a preauth SSRF can for example be used by an attacker to make a network scan from the TOE and discover its next targets

[TODO]: add:
 - practical test steps for pentesting the capacity to recompose malicious data through gateways, diodes...


