---
title: Pentesting an SSH server
---

# Introduction
This method is focused on elevating privileges from SSH access, following these steps:
 - quick checks [mandatory] (to quickly assess the presence of trivial issues such as the use of SSH v1). 
 - guidance checks [mandatory] (to assess that the minimal warnings are given to the users)
 - crypto checks [mandatory] (to check that only robust mechanisms are used)
 - config checks [mandatory] (to check weak/dangerous configuration)
 - pivoting [optional] (to check if the TOE can be used to threaten other systems). This may not be applicable to all evaluations
 - fuzzing [optional] (to go further in the research of SW errors on the implementation). This will typically not be applicable for well-used implementations such as OpenSSH 
 - Annex: PoC is mostly dedicated to challenges and CTFs related to SSH, or cases where a customer requires a proof of concept 

# Quick checks
These checks are available for whitebox (CC)  and blackbox (BSZ/CSPN) approaches.

## Whitebox
From a root access on the TOE, retrieve the contents of
 - /etc/ssh/sshd_config and,
 - if it exists, /etc/ssh/authorized_keys 
 - If a SSH client is used on the TOE, 
     - users configuration files (~/.ssh/config)
     - the system-wide configuration file (/etc/ssh/ssh_config)

### In sshd_config
 - check if the TOE uses [Allow|Deny][Users|Group] consistently with user and group TOE access control policy
 - AllowTCPForwarding should be set to no, but as users have shell access, this should be eplored further, rather than be a blocking point 
 - check if ChrootDirectory is used
 - Cipher Algorithms should be compliant to BSI [TR-02102-4], and must in any case not be weak/broken. 
 - Compression should be set to delayed or no to avoid preauth attacks
 - HostbasedAuthentication must be set to no
 - KerberosAuthentication should be set to no 
 - MaxAuthTries must be set to limit the brute force attempts
 - PasswordAuthentication should be set to no (otherwise each security incident on the server risks leaking the user keys, which will then have to be changed)
 - PermitEmptyPasswords should be set to no
 - PermitOpen should not be used
 - PermitRootLogin should be set to no 
 - PermitTunnel should be set to no
 - PermitUserEnvironment should be set to no
 - Protocol must be 2
 - StrictModes should be set to yes
 - UsePAM should be set to yes. Meaning that sshd has to run as root, also check that UsePrivilegeSeparation is set to yes
 - X11Forwarding should be set to no
 - if SFTP is active, and for users accessing SFTP, the ForceCommand parameter should be set to internal-sftp, in order to avoid [SFTP command execution](https://book.hacktricks.xyz/network-services-pentesting/pentesting-ssh)

### In authorized_keys
Check if the TOE uses the capacity to limit some users to some commands, and with which options

### In ssh_config and users ssh/config files
The SSH client is less of a threat for the TOE, since is it used to access other IT products by users already logged on the TOE. The only potential risks are_
 - the leak of sensitive user material on the SSH channel to another IT Product
 - the possibility of using the TOE as an attack vector targeting other IT products. 

The basic verifications on this topic will be:   
 - Cipher Algorithms should be compliant to BSI [TR-02102-4], and must in any case not be weak/broken. 
 - X11Forwarding should be set to no

Other verifications may be needed depending on the context.

NB: Deviations from these results should not necessarily be considered a fail criterion but rather a hint that some additional pentests are necessary

## Blackbox
*Banner:* You can grab the banner via (nc -vn <ip> 22) but it's much simpler to just type a few basic nmap commands:
```
nmap -p22 <ip> -sC # Send default nmap scripts for SSH, will give you a fingerprint of the host keys
nmap -p22 <ip> -sV # will try to retrieve the version of the SSH but more importantly gives you the supported version of the protocol WHICH SHOULD BE 2!
nmap -p22 <ip> --script ssh2-enum-algos # Lists the supported algorithms, see crypto 
ssh-keyscan -p 22 <ip> # Retrieve host public keys 
nmap -p22 <ip> --script ssh-hostkey --script-args ssh_hostkey=full # alternative to retrieve host public keys but keyscan is more likely to work
nmap -p22 <ip> --script ssh-auth-methods --script-args="ssh.user=root" # Lists authentication methods
```

# Guidance
In CC evaluations or similar contexts, check AGD doc to verify that
- it forces admin to change default host keys / user passwords (if not and if PoC is needed, goto CTF section) 
- it warns users against server key changes, that could be due to a MitM (if not and if PoC is needed, goto CTF)

# Crypto
Based on the list of available ciphers, check conformity to BSI [TR-02102-4]
(NB: rather than use [SSH audit](https://github.com/jtesta/ssh-audit) and blindly trust the tool recommendations)

# Config
If in white box, explore config files in /etc/ssh
- sshd_config
    . check is rhosts is possible
    . check MaxAuthTries 
    . check that PasswordAuthentication is no, unless expressly allowed in the ST
    . check if PermitRootLogin is set to yes -> goto Fuzzing
    . check if the TOE uses AllowUsers and DenyUsers consistently with user definition
    . check PermitEmptyPasswords no (and check with password policy in AGD)
    . check if chroot
- authorized_keys
    . check restriction of commands 

# Pivoting
## network pivot
If in white box, explore config files in /etc/ssh
- sshd_config
    . check if AllowTcpForwarding is set to yes
    . check if X11Forwarding is yes
See https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding
See https://github.com/MegaManSec/SSH-Snake

## control characters and log injection
try to inject control characters in login names, cipher, or any other text possibly written in logs

# Fuzzing

By default, fuzzing should be selected only on proprietary/unusual implementations. If the TOE uses a patched OpenSSH, it is not likely that we will find anything in a constraint-time fuzzing campaign.

If fuzzing has to be performed, here are a few hints that can be explored

Two preexisting tools that may not be very interesting:
 - an existing Perl script: https://packetstormsecurity.com/files/download/71252/sshfuzz.txt
 - additional fuzzing on version strings (same): https://www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh_version_2

For a serious attempt to fuzz e.g. with AFL, see https://www.vegardno.net/2017/03/fuzzing-openssh-daemon-using-afl.html 


# Annex: PoC 
This section actually makes sense ony in a blackbox setting, when the TOE does not allow to regenerate host keys... or in CTF

## Weak/already compromised keys 

*Quick test:* If short RSA host keys are used, Get the public SSH key of server, then convert it to x509
```
ssh-keyscan -t rsa <IP> -p <PORT> > sshpub.pub # if you haven't the key already
ssh-keygen -f  sshpub.pub -e -m pem  
```
decode the ASN.1 with http://ldh.org/asn1.html or openssl asn1decode (supposedly this works but not on my computer : sed "/--/d" sshpub.pem | openssl asn1parse | grep "INTEGER" | sed "s/.*://")
Eventually check the modulus in http://www.factordb.com/ (after a hex to decimal conversion)

NB: beware that keyscan may give you a public key that is present but not used! so better to check with nmap, which will tell you if the key is actually used.

*Known bad keys:*
use Metasploit scanner/ssh/ssh_identify_pubkeys or nmap (see https://nmap.org/nsedoc/scripts/ssh-publickey-acceptance.html) to check whether a known bad key has been used (https://github.com/rapid7/ssh-badkeys/tree/master/authorized)

NB: very specific case of CVE-2008-0166: If the SSH is age 2006-2008, or if the key is likely to have been generated at this time, you can exploit : https://github.com/g0tmi1k/debian-ssh 

## User enumeration and password brute force
Enumeration is (theoretically) possible with metasploit, using the technique described in https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/auxiliary/scanner/ssh/ssh_enumusers.md
(I could not make it work in a test setting, though, soI do not develop the brute force part of it, it might need tinkering anyway)

*Known default passwords* : check https://book.hacktricks.xyz/network-services-pentesting/pentesting-ssh#default-credentials
(only relevant for CTFs!)

## MitM
Nothing to do by default but check https://github.com/jtesta/ssh-mitm if the customer needs an exploit
