---
description: Additional network methods  
---

# Table of contents
* Bypass flow control (network evasion)
* Tamper/craft TOE outputs (pivoting, output poisoning)


# Bypass flow control (network evasion)
The typical example of flow control as a primary security function is a firewall function or VPN. The actual flow control functionality will depend on the TOE. In this example, _bypassing control flow_ means _evading the FW rules_, _making cleartext flow to/from the VPN_ or simply _circumventing the confidentiality/integrity protection of the VPN_. Similar types of attacks can concern:

* Network switches: bypassing the VLAN segregation
* Diodes: bypassing the unidirectionnality, or the content inspection...
* etc.




## TCP/IP layer attacks
[TODO] complete with:
 - [nsa23]:  National Security Agency | Cybersecurity Information Sheet IPv6 Security Guidance, 2023
 - [Ull14]:  Johanna Ullrich, Katharina Krombholz, Heidelinde Hobel, Adrian Dabrowski, Edgar Weippl  - IPv6 Security: Attacks and Countermeasures in a Nutshell (Usenix 2014) 
 - [WWW-layer2](https://www.whitewinterwolf.com/posts/2017/10/10/practical-network-layer-2-exploitation-introduction/#series-toc)
 - [Hacktricks-network](https://book.hacktricks.xyz/generic-methodologies-and-resources/pentesting-network)

### Fragmentation attacks
Tests:
 - **Simple fragmentation attacks**
     - **IPv4:** check that the TOE drops packets with Fragment Offset = 1 (see [RFC1858](https://datatracker.ietf.org/doc/html/rfc1858))
     - **IPv6:** 
         - test: check _any_ overlapping fragment is dropped (see [RFC5722](https://datatracker.ietf.org/doc/html/rfc5722))
         - review: check that initial fragments without flags or port numbers are _treated with suspicion_ (see [IPv6 Security: Attacks and Countermeasures in a Nutshell, Ullrich et al](https://www.usenix.org/system/files/conference/woot14/woot14-ullrich.pdf))
         - review: check that atomic fragments are processed independently from normal fragments (see [RFC6946](https://www.rfc-editor.org/rfc/rfc6946))
 - **More complex fragmentation attacks** are hard to assess them at the level of a CC evaluation: the principle of fragmentation attacks is to leverage the difference in packet filtering/recomposition between the IDS/FW and the target, in order to perform FW/IDS evasion or IDS insertion. It should _not_ be explored, unless the TOE includes _both the IDS and the target_, and/or _explicitly claims resistance to these attacks_: in this case, clarify the IDS and target behaviours as part of ADV to inform the tests. 
 - **DoS:** classical DoS fragmentation attacks (such as Teardrop/Nestea/Bonk/Jolt2/etc) should _not_ be explored, unless the TOE claims resistance to DoS

Tools and practical example: [TODO:] add a PoC with ScaPy/pwntools using e.g. [this writeup](https://www.supernetworks.org/pages/blog/scapy-revfrag)

Note on exploitation (normally not needed):
 - **On IPv4**, the evaluator may typically want to bypass packet filters that apply rules on the first fragment only:
     - tiny (TCP) fragments, so that TCP flags are on the next fragments (and consequently ignored)
     - overlapping fragments, so that the first fragment contains innocuous header information, that will be rewritten by the next fragments.
 - **On IPv6**, attacks may be more ambitious, since the overlapping may be used to overwrite more information (such as source or destination ports). See [Attacking IPv6 Implementation Using Fragmentation, Antonios Atlasis](https://media.blackhat.com/bh-eu-12/Atlasis/bh-eu-12-Atlasis-Attacking_IPv6-WP.pdf) for more details.

### ARP and NDP/ND
IPv4: Does the TOE allow ARP spoofing or ARP poisoning within its virtual networks?
are there countermeasures? (cf. Cisco Dynamic ARP Inspection or usage of static ARP tables)

Reference:
 - RFC 826 - Ethernet Address Resolution Protocol
 - RFC 903 - Reverse Address Resolution Protocol
 - RFC 2390 - Inverse Address Resolution Protocol
 - RFC 5227 - IPv4 Address Conflict Detection

IPv6: 
 - size of subnets introduces specific DoS risks, see [RFC 6583] - is the TOE vulnerable?
 - equivalent risks to ARP (spoofing, etc) -> check literature
Reference:
 - RFC 1970
 - RFC 2461
 - RFC 4861
 - RFC 3122
 - RFC 4389

### DoS
**If the TOE claims resistance to DoS**, the evaluator may try "antique" attacks on TCP (a syn flood with [hping3](https://www.kali.org/tools/hping3/) or [Naptha](https://packetstormsecurity.com/0101-exploits/naptha-1.1.tgz)). However, this should not be tested by default.


### Classical attacks on ICMP
Does the TOE allow attacks on ICMP ?
 - ICMP Sweep, e.g. for network discovery.
 - ICMP Redirect, e.g. to bypass firewalls
 - ICMP type 3, e.g. to forcibly close TCP connections
 - ICMP type 3 or 4 for DoS (bandwidth exhaustion).

Reference: RFC 792 and RFC 4443

### tunneling and translation attacks

see possibility of undesired transition between methods (6to4 [2], ISATAP [3], Teredo [4], etc.) 
### Bonus: IPv6 specifics
 - Check if Split DNS is used, and try to recover AAA records from an internal host if a PoC is needed
 - Check if the TOE prevents guests to send router advertisement messages (see rfc6105)<br> - Check if the TOE prevents guests to deploy a rogue DHCP server (see rfc7610)

Rationale:
 - DNS
     - NSA guidance : The Domain Name System (DNS) has been expanded for IPv6 with a new AAAA record that provides IPv6 addresses in addition to the A record that provides IPv4 addresses. 
     - Therefore, a dual stack DNS implementation may need to support both A and AAAA records. Due to SLAAC and other mechanisms, sensitive information could be included in the AAAA records for internal hosts. Split DNS uses two separate DNS servers created for the same domain, one for the external network and one for the internal network. The goal of split DNS, as opposed to a single DNS, is to increase security and privacy by not inadvertently exposing sensitive information in a DNS record from the internal network to the external network. NSA recommends implementing split DNS, for both IPv4 and IPv6 networks
 - local link
	 - NSA guidance : IPv6 defines network functions that operate on the local link. This includes link-layer address resolution, router discovery, and stateless auto-configuration of addresses. Compared to IPv4, local-link operations for IPv6 are more complex and provide more attack surface. Therefore, any relevant mitigations (i.e., Router Advertisement (RA) Guard to protect against rogue RA messages, Dynamic Host Configuration Protocol for IPv6 (DHCPv6) Shield to protect against rogue DHCPv6 servers) provided by switches and routers should be considered.


## Reverse proxies
[TODO] To be defined following:
 - https://www.sans.org/blog/http-request-smuggling-abusing-reverse-proxies/
 - https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies, 
 - https://threatpost.com/url-parsing-bugs-dos-rce-spoofing/177493/ and 
 - https://www.acunetix.com/blog/articles/a-fresh-look-on-reverse-proxy-related-attacks/ (which contains more attacks than just the parsing inconsistencies)

## VPN and secure channels
Regardless of potential privilege escalation, a protocol may provide security properties (integrity, confidentiality, anti-replay...). As a part of a general *Information flow bypass*, the evaluator should try to check whether the protocol itself can be bypassed
 - [TODO] secure channel
 - [TODO] kill switch / firewall part of the secure channel
## FW evasion
 - [TODO] add external resources on FW evasion and discuss - testing FW evasion is tricky, since it is dependent on context, rules expressiveness and usability, etc. For the moment, this aspect is not addressed in this method and is considered more a functional test of the FW capacity than a security topic. The same rules holds for gateway that allow or block traffic based on protocol analyses.
## Diodes and TAPs
 - [TODO] attacks on directionality / protocol translation
 - [TODO] out of scope: HW attacks on optical diodes


# Tamper/craft TOE outputs (pivoting, output poisoning)

The scenario consists in either

* crafting outputs to support another attack (e.g. erasing error messages from a log)
* crafting an input so that the TOE creates a malicious output (e.g. log poisoning). A weaker version consists in using the TOE to tunnel malicious content (e.g. port forwarding to another target).


## log tampering
 - [TODO] erase messages / inject content in the logs
## Tunnel/forward malicious content through the TOE

For firewalls and similar:
 - IPv6: check that the TOE rewrites all non-zero flow labels originating from a potentially compromised device, as it can be used as a covert channel (see [RFC 6437](https://datatracker.ietf.org/doc/html/rfc6437))
 - [TODO] see notably SSH forwarding etc
## Emit malicious content through the TOE 
this case is a bit different, since it supposes that the attacker can use the TOE itself to transform input data in malicious data for other systems connected to the TOE. It requires 
 - either that the attacker exploits TOE input transformation rules,  
 - or that the attacker elevates their privileges on the TOE to craft arbitrary malicious data. In real life scenarios,
 - a preauth SSRF can for example be used by an attacker to make a network scan from the TOE and discover its next targets
 - logs could be poisoned so as to include malicious content for the software that will read them
 - etc

[TODO]: add:
 - practical test steps for pentesting the capacity to recompose malicious data through gateways, diodes...
 - how to setup a test lab without real devices (EVE-NG, etc)


