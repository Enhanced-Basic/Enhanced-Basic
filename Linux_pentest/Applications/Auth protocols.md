# Tokens
Many elements here are lifted from several good primers that can be found here: https://medium.com/@robert.broeckelmann/saml2-vs-jwt-a-comparison-254bafd98e6 (TODO: not completely included in this method!!!) and there: https://darutk.medium.com/inclusion-relation-among-jws-jwe-jwt-id-token-and-access-token-a99312fc1ad4

## JWT (JSON Web token)
### Token Type
* OAuth2: access_token (can be JWT, but doesn’t have to be)
* OIDC: access_token (can be JWT) and id-token (must be JWT).
#### OAuth2 family of specs
#### OpenID Connect family of specs

### Data Structure - [RFC 7519](https://www.rfc-editor.org/rfc/rfc7519.html)
### Logical structure
JWT: JSON (interestingly, structure is NOT defined by JSON Schema). 
JSON Web Token is a standard format that can be signed and/or encrypted. When a token is signed it uses JSON Web Signature (JWS), when encrypted it uses JSON Web Encryption (JWE)

In practice the JWT includes a signed [Open ID token](https://openid.net/specs/openid-connect-core-1_0.html#IDToken). this can be either
 - a JWS ID Token 
 - a nested JWT, that includes a "JWE including JWS" ID token

NB: ID Token never takes the form of “JWS including JWE”. It’s because when ID Token is encrypted, the order must be “signed then encrypted” as the specification requires so.

#### JWS - [RFC 7515](https://www.rfc-editor.org/rfc/rfc7515.html)
Allows compact and JSON serialization. A JWT token using JWS always use compact serialization
#### JWE - [RFC 7516](https://www.rfc-editor.org/rfc/rfc7516.html)
Allows compact and JSON serialization. A JWT token using JWE always use compact serialization

### Implementation
JWTs consists of three Base64 strings separated by dots. They are the Header, Payload, and Signature.

#### Header
The header typically consists of two parts: the type of the token, which is JWT, and the hashing algorithm such as HMAC SHA256 ("signature" by symmetric key) or RSA/ECDSA.
Example:
````
{
  'alg': 'HS256',
  'typ': 'JWT'
}
````
This is base64 encoded and passed before the first .

#### Payload
The second part of the token is the payload, which contains the claims. Claims are statements about an entity (typically, the user) and additional metadata. There are three types of claims:
 - Reserved claims: These are a set of predefined claims, which are not mandatory but recommended, thought to provide a set of useful, interoperable claims. Some of them are: iss (issuer), exp (expiration time), sub (subject), aud (audience), among others.
 - Public claims: These can be defined at will by those using JWTs. But to avoid collisions they should be defined in the IANA JSON Web Token Registry or be defined as a URI that contains a collision resistant namespace., and 
 - private claims: These are the custom claims created to share information between parties that agree on using them.
Example:
```` 
{
  'sub': '1234567890',
  'name': 'John Doe',
  'admin': true
}
```` 
Is is then, as the header, base64 encoded and passed as it is
#### Signature
To create the signature part you have to take the encoded header, the encoded payload, a secret, the algorithm specified in the header, and sign that.

For example if you want to use the HMAC SHA256 algorithm, the signature will be created in the following way.

HMACSHA256(
  base64UrlEncode(header) + '.' +
  base64UrlEncode(payload),
  secret)


### Size
JWT: Much smaller than SAML2 tokens. Spec encourages use of reference to signature certificate rather than embedding it — eliminates large x509 signer cert.

### X509 Certificate representation
JWT: JSON Web Key spec (JWK)


### What to check
 - what are the algorithms?
 - which are public, reserved, private claims? are there possible collisions? Are public claims defined in the IANA JSON Web Token Registry or as a URI that contains a collision resistant namespace? 
 - Check the origin of the parser, then make the inventory of its quirks:
https://bishopfox.com/blog/json-interoperability-vulnerabilities

## SAML (XML)
### Token Type
SAML2: SAML Assertion (format strictly defined by specs)

### Data Structure
SAML2: XML (structure defined with XSD)

### Size
SAML2: Tend to be very large in comparison to JWT. Size varies depending on what fields are present, use of Signatures and Encryption.

### X509 Certificate representation

SAML2: X509BinarySecurityToken type

### SAML2 family of specs
### XML Digital Signature
### XML Encryption
### WS-Security
### WS-Trust

### Vulns state of the art
https://www.scalekit.com/blog/a-saml-security-vulnerability-handbook-for-developers
